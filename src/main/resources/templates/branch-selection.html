<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Branch - Smart Code Review</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-git"></i> Select Branch to Analyze
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Repository Info -->
                        <div class="alert alert-success" role="alert">
                            <h5><i class="bi bi-check-circle"></i> Repository Found</h5>
                            <p class="mb-1"><strong>Repository:</strong> <span th:text="${repository.fullName}">owner/repo</span></p>
                            <p class="mb-1"><strong>Language:</strong> <span th:text="${repository.language}">Java</span></p>
                            <small class="text-muted">Public repository • <span th:text="${remainingScans}">3</span> scans remaining</small>
                        </div>
                        
						<!-- File Statistics -->
						<div class="card mb-4">
						    <div class="card-header d-flex justify-content-between align-items-center">
						        <h6 class="mb-0"><i class="bi bi-file-earmark-code"></i> Analysis Preview</h6>
						        <span class="badge bg-success">FREE ANALYSIS</span>
						    </div>
						    <div class="card-body">
						        <div class="row text-center">
						            <div class="col-md-3">
						                <strong data-stat="total-files" th:text="${fileStats?.totalFiles ?: '0'}">0</strong><br>
						                <small class="text-muted">Total Files</small>
						            </div>
						            <div class="col-md-3">
						                <strong data-stat="code-files" th:text="${fileStats?.eligibleFiles ?: '0'}">0</strong><br>
						                <small class="text-muted">Code Files</small>
						            </div>
						            <div class="col-md-3">
						                <strong data-stat="tokens" th:text="${fileStats?.estimatedTokens ?: '0'}">0</strong><br>
						                <small class="text-muted">Est. Tokens</small>
						            </div>
						            <div class="col-md-3">
						                <div data-stat="cost">
						                    <span style="text-decoration: line-through;">
						                        <strong>$<span th:text="${#numbers.formatDecimal((fileStats?.estimatedCost ?: 0) * 5, 1, 4)}">0.0000</span></strong>
						                    </span><br>
						                    <span class="text-success"><strong>FREE</strong></span>
						                </div>
						                <small class="text-muted">Analysis Cost</small>
						            </div>
						        </div>
						        <div class="text-center mt-2">
						            <small class="text-info">
						                <i class="bi bi-info-circle"></i> Analysis is currently free during beta testing
						            </small>
						        </div>
						    </div>
						</div>
                        
                        <!-- Branch Selection Form -->
                        <form th:action="@{/analyze}" method="post">
                            <input type="hidden" name="sessionId" th:value="${sessionId}">
                            <input type="hidden" name="repoUrl" th:value="${repository.url}">
                            
                            <div class="mb-3">
                                <label for="branch" class="form-label">
                                    <i class="bi bi-git"></i> Select Branch to Analyze
                                </label>
                                <select class="form-control" id="branch" name="branch" required>
                                    <option value="">-- Choose a branch --</option>
                                    <option th:each="branch : ${branches}" 
                                            th:value="${branch.name}" 
                                            th:text="${branch.name + (branch.isDefault ? ' (default)' : '')}"
                                            th:selected="${branch.isDefault}">
                                    </option>
                                </select>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" 
                                        th:disabled="${remainingScans <= 0}">
                                    <i class="bi bi-play-circle"></i> Start Code Analysis
                                </button>
                            </div>
                        </form>
                        
                        <hr class="my-4">
                        
                        <!-- Navigation -->
                        <div class="d-flex justify-content-between">
                            <a th:href="@{/repository(sessionId=${sessionId})}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Repository Selection
                            </a>
                            <small class="text-muted align-self-center">
                                Session: <code th:text="${sessionId}">session-id</code>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">
	    // Get template variables
	    const sessionId = /*[[${sessionId}]]*/ '';
	    const repoUrl = /*[[${repository.url}]]*/ '';
	    
	    // Auto-select default branch and load its stats
	    window.addEventListener('load', function() {
	        const branchSelect = document.getElementById('branch');
	        const defaultOption = branchSelect.querySelector('option[selected]');
	        if (defaultOption) {
	            branchSelect.value = defaultOption.value;
	        }
	        
	        console.log('🔧 Page loaded - SessionId:', sessionId, 'RepoUrl:', repoUrl);
	    });
	    
	    // Update file statistics when branch changes
	    document.getElementById('branch').addEventListener('change', function() {
	        const selectedBranch = this.value;
	        if (!selectedBranch) {
	            resetFileStats();
	            return;
	        }
	        
	        console.log('🔄 Branch changed to:', selectedBranch);
	        
	        // Show loading state
	        showLoadingStats();
	        
	        // Build API URL
	        const apiUrl = `/api/branch-stats?sessionId=${encodeURIComponent(sessionId)}&repoUrl=${encodeURIComponent(repoUrl)}&branch=${encodeURIComponent(selectedBranch)}`;
	        console.log('🌐 Fetching:', apiUrl);
	        
	        // Fetch file stats for selected branch
	        fetch(apiUrl)
	            .then(response => {
	                console.log('📡 Response status:', response.status);
	                if (!response.ok) {
	                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
	                }
	                return response.json();
	            })
	            .then(data => {
	                console.log('📊 Received data:', data);
	                if (data.status === 'success') {
	                    updateFileStats(data);
	                } else {
	                    console.error('❌ API returned error:', data.message);
	                    showErrorStats();
	                }
	            })
	            .catch(error => {
	                console.error('💥 Error fetching branch stats:', error);
	                showErrorStats();
	            });
	    });
	    
	    function showLoadingStats() {
	        updateStatsDisplay('Loading...', 'Loading...', 'Loading...', 'Loading...');
	    }
	    
	    function updateFileStats(stats) {
	        const adjustedCost = (stats.estimatedCost || 0) * 5;
	        const costDisplay = `<span style="text-decoration: line-through;">$${adjustedCost.toFixed(4)}</span><br><span class="text-success">FREE</span>`;
	        
	        updateStatsDisplay(
	            stats.totalFiles || 0,
	            stats.eligibleFiles || 0,
	            stats.estimatedTokens || 0,
	            costDisplay
	        );
	        
	        console.log(`✅ Updated stats for branch - Files: ${stats.eligibleFiles}, Cost: $${adjustedCost.toFixed(4)} (FREE)`);
	    }
	    
	    function resetFileStats() {
	        updateStatsDisplay('-', '-', '-', '-');
	    }
	    
	    function showErrorStats() {
	        updateStatsDisplay('Error', 'Error', 'Error', 'Error');
	    }
	    
	    function updateStatsDisplay(totalFiles, codeFiles, tokens, cost) {
	        const totalElement = document.querySelector('[data-stat="total-files"]');
	        const codeElement = document.querySelector('[data-stat="code-files"]');
	        const tokensElement = document.querySelector('[data-stat="tokens"]');
	        const costElement = document.querySelector('[data-stat="cost"]');
	        
	        if (totalElement) totalElement.innerHTML = totalFiles;
	        if (codeElement) codeElement.innerHTML = codeFiles;
	        if (tokensElement) tokensElement.innerHTML = tokens;
	        if (costElement) costElement.innerHTML = cost;
	    }
	</script>
</body>
</html>